services:
  api-gateway:
    build:
      context: .
      dockerfile: Dockerfile
    image: ${DOCKERHUB_USERNAME}/temandifa-gateway:latest
    ports:
      - "3000:3000"
    env_file:
      - .env
    depends_on:
      - yolo-detector
      - voice-transcriber
      - ocr-service
    networks:
      - temandifa-net

  python-base-builder:
    build:
      context: .
      dockerfile: base/Dockerfile
    image: temandifa-python-base:latest

  yolo-detector:
    build:
      context: ./yolo_detector
      dockerfile: Dockerfile
    image: ${DOCKERHUB_USERNAME}/temandifa-yolo:latest
    environment:
      - GUNICORN_WORKERS=${GUNICORN_WORKERS:-2}
    depends_on:
      - python-base-builder
    networks:
      - temandifa-net

  voice-transcriber:
    build:
      context: ./voice_transcriber
      dockerfile: Dockerfile
    image: ${DOCKERHUB_USERNAME}/temandifa-transcriber:latest
    environment:
      - GUNICORN_WORKERS=${GUNICORN_WORKERS:-2}
    depends_on:
      - python-base-builder
    networks:
      - temandifa-net

  ocr-service:
    build:
      context: ./ocr_service
      dockerfile: Dockerfile
    image: ${DOCKERHUB_USERNAME}/temandifa-ocr:latest
    environment:
      - GUNICORN_WORKERS=${GUNICORN_WORKERS:-2}
    depends_on:
      - python-base-builder
    networks:
      - temandifa-net

  prometheus:
    image: prom/prometheus:latest
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
    ports:
      - "9090:9090"
    networks:
      - temandifa-net

  grafana:
    image: grafana/grafana-oss:latest
    ports:
      - "4000:3000"
    volumes:
      - ./grafana/provisioning/datasources:/etc/grafana/provisioning/datasources
    depends_on:
      - prometheus
    networks:
      - temandifa-net

networks:
  temandifa-net:
    driver: bridge